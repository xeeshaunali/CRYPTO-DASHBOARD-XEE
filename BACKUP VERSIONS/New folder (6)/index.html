<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SUPER BOT v4 – Signals, Rotation & Real-Time Order Flow</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap CSS + JS Bundle (includes Popper) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- TradingView Widget -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <style>
        .positive { color: green; font-weight: bold; }
        .negative { color: red; font-weight: bold; }
        .signal-bullish { color: #0f5132; font-weight: bold; background-color: #d1e7dd; }
        .signal-bearish { color: #842029; font-weight: bold; background-color: #f8d7da; }
        .signal-watch { color: #664d03; font-weight: bold; background-color: #fff3cd; }
        .imbalance-pos { color: green; font-weight: bold; }
        .imbalance-neg { color: red; font-weight: bold; }
        table { font-size: 0.9em; }
        .card { margin-bottom: 1rem; }
        .exchange-controls { 
            background-color: #f8f9fa; 
            padding: 15px; 
            border-radius: 5px; 
            margin-bottom: 20px; 
            border: 1px solid #dee2e6;
        }
        .form-check-inline { margin-right: 15px; }
        
        /* Enhanced Prediction Styles */
        .signal-strong-bullish { 
            color: #0d6efd; 
            background-color: #d1e7ff; 
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .signal-bullish { 
            color: #198754; 
            background-color: #d1e7dd; 
            padding: 5px 10px;
            border-radius: 4px;
        }
        .signal-bearish { 
            color: #dc3545; 
            background-color: #f8d7da; 
            padding: 5px 10px;
            border-radius: 4px;
        }
        .signal-neutral { 
            color: #6c757d; 
            background-color: #f8f9fa; 
            padding: 5px 10px;
            border-radius: 4px;
        }
        .prediction-high { color: #198754; font-weight: bold; }
        .prediction-medium { color: #fd7e14; font-weight: bold; }
        .prediction-low { color: #dc3545; font-weight: bold; }
        .chart-container { height: 400px; }
        .progress { height: 20px; }
    </style>
</head>
<body>
<div class="container mt-4">
    <h1 class="text-center text-primary mb-4">SUPER BOT v4 – Signals, Rotation & Real-Time Order Flow</h1>

    <!-- Live Symbol Selector for Real-Time Tabs -->
    <div class="row mb-4">
        <div class="col-md-5">
            <label class="form-label fw-bold">Live Symbol for Order Book & Trades</label>
            <input id="liveSymbol" class="form-control" value="BTC/USDT" placeholder="e.g. SOL/USDT, PHB/USDT">
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-primary w-100" onclick="setLiveSymbol()">Set Live Symbol</button>
        </div>
        <div class="col-md-4 d-flex align-items-end">
            <div id="liveSymbolStatus" class="ms-3 text-muted fst-italic"></div>
        </div>
    </div>

    <ul class="nav nav-tabs mb-4" id="mainTabs">
        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#ohlcv">OHLCV</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#signals">Signals</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#gainers">Gainers</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#losers">Losers</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#rotation">Rotation</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#orderbook">Order Book (Live)</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#trades">Trades (Live)</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#predictions">Predictions</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#system">System</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#symbols">Symbols</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#trainBot">Train Bot</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#predictCandle">Predict Candle</a></li>
    </ul>

    <div class="tab-content">
        <!-- OHLCV -->
        <div class="tab-pane fade show active" id="ohlcv">
            <div class="row g-3 mb-3">
                <div class="col-md-4">
                    <input id="symbol" class="form-control" value="BTC/USDT" placeholder="e.g. PHB/USDT">
                </div>
                <div class="col-md-3">
                    <select id="timeframe" class="form-control">
                        <option value="1m">1m</option>
                        <option value="5m">5m</option>
                        <option value="15m">15m</option>
                        <option value="1h">1h</option>
                        <option value="4h" selected>4h</option>
                        <option value="1d">1d</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small">From Year</label>
                    <input type="number" id="fromYear" class="form-control" min="2000" max="2100">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">To Year</label>
                    <input type="number" id="toYear" class="form-control" min="2000" max="2100">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button class="btn btn-success w-100" onclick="fetchOHLCV()">Fetch Live</button>
                </div>
            </div>
            <button class="btn btn-warning mb-3" onclick="loadFromDB()">Load from DB</button>
            <div id="ohlcvAlert"></div>
            <table class="table table-sm table-bordered table-striped">
                <thead class="table-dark">
                    <tr><th>#</th><th>Time (UTC)</th><th>Open</th><th>High</th><th>Low</th><th>Close</th><th>Volume</th><th>Vol Change</th></tr>
                </thead>
                <tbody id="ohlcvBody"></tbody>
            </table>
        </div>

        <!-- SIGNALS -->
        <div class="tab-pane fade" id="signals">
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <input id="signalSymbol" class="form-control" value="BTC/USDT">
                </div>
                <div class="col-md-3">
                    <select id="signalTimeframe" class="form-control">
                        <option value="15m">15m</option>
                        <option value="1h">1h</option>
                        <option value="4h" selected>4h</option>
                        <option value="1d">1d</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" onclick="analyzeSymbol()">Analyze</button>
                </div>
            </div>
            <div id="signalAlert"></div>
            <div class="card mb-4">
                <div class="card-header">Latest Candle & Indicators</div>
                <div class="card-body" id="signalDetails">
                    <p class="text-muted mb-0">Run analysis to see RSI / MACD / EMAs and signal here.</p>
                </div>
            </div>
            <h4>Signals for Today's Top Gainers</h4>
            <button class="btn btn-success mb-3" onclick="loadGainerSignals()">Scan Gainers</button>
            <div id="gainerSignalsAlert"></div>
            <table class="table table-bordered table-sm">
                <thead class="table-success">
                    <tr>
                        <th>#</th><th>Symbol</th><th>24h %</th><th>Volume</th><th>Close</th><th>RSI</th><th>Signal</th><th>Score</th>
                    </tr>
                </thead>
                <tbody id="gainerSignalsBody"></tbody>
            </table>
        </div>

        <!-- GAINERS -->
        <div class="tab-pane fade" id="gainers">
            <div class="text-center my-3">
                <button class="btn btn-success" onclick="refreshGainersLosers()">Refresh Gainers & Losers</button>
                <div id="gainersAlert" class="mt-3"></div>
            </div>
            <table class="table table-bordered">
                <thead class="table-success">
                    <tr><th>#</th><th>Symbol</th><th>Price</th><th>24h %</th><th>Volume</th></tr>
                </thead>
                <tbody id="gainersBody"></tbody>
            </table>
        </div>

        <!-- LOSERS -->
        <div class="tab-pane fade" id="losers">
            <div class="text-center my-3">
                <button class="btn btn-danger" onclick="refreshGainersLosers()">Refresh Gainers & Losers</button>
                <div id="losersAlert" class="mt-3"></div>
            </div>
            <table class="table table-bordered">
                <thead class="table-danger">
                    <tr><th>#</th><th>Symbol</th><th>Price</th><th>24h %</th><th>Volume</th></tr>
                </thead>
                <tbody id="losersBody"></tbody>
            </table>
        </div>

        <!-- ROTATION -->
        <div class="tab-pane fade" id="rotation">
            <div class="text-center my-3">
                <p>Rotation logic: when one coin pumps, find similar-use-case coins with lower or equal size and bullish signals.</p>
                <button class="btn btn-primary" onclick="loadRotation()">Scan Rotation Opportunities</button>
                <div id="rotationAlert" class="mt-3"></div>
            </div>
            <div id="rotationResults"></div>
        </div>

        <!-- ORDER BOOK (LIVE) - MODIFIED WITH CHECKBOXES -->
        <div class="tab-pane fade" id="orderbook">
            <h4 class="mb-3">Live Combined Order Book & Order Flow</h4>
            
            <div class="exchange-controls">
                <div class="row">
                    <div class="col-md-8">
                        <label class="form-label fw-bold">Select Exchanges:</label>
                        <div class="mt-2">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="exchangeAll" checked onchange="toggleAllExchanges()">
                                <label class="form-check-label" for="exchangeAll">All</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input exchange-checkbox" type="checkbox" id="exchangeBinance" value="binance" checked onchange="updateExchangeSelection()">
                                <label class="form-check-label" for="exchangeBinance">Binance</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input exchange-checkbox" type="checkbox" id="exchangeBybit" value="bybit" checked onchange="updateExchangeSelection()">
                                <label class="form-check-label" for="exchangeBybit">Bybit</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input exchange-checkbox" type="checkbox" id="exchangeOKX" value="okx" checked onchange="updateExchangeSelection()">
                                <label class="form-check-label" for="exchangeOKX">OKX</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input exchange-checkbox" type="checkbox" id="exchangeGateio" value="gateio" checked onchange="updateExchangeSelection()">
                                <label class="form-check-label" for="exchangeGateio">Gate.io</label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Depth Levels:</label>
                        <select id="depthLevels" class="form-select" onchange="updateRealTime()">
                            <option value="10">10 levels</option>
                            <option value="15" selected>15 levels</option>
                            <option value="20">20 levels</option>
                            <option value="25">25 levels</option>
                            <option value="30">30 levels</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="alert alert-info py-2 mb-0" id="exchangeStatus">
                            <small>Selected: Binance, Bybit, OKX, Gate.io</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="orderBookContent" class="border p-4 bg-light rounded">
                <p class="text-muted">Select a symbol at the top and wait for real-time data to load...</p>
            </div>
        </div>

        <!-- TRADES (LIVE) -->
        <div class="tab-pane fade" id="trades">
            <h4 class="mb-3">Recent Executed Trades (Buy/Sell Aggression)</h4>
            <div id="tradesContent" class="border p-4 bg-light rounded">
                <p class="text-muted">Loading live trades...</p>
            </div>
        </div>

        <!-- PREDICTIONS - ENHANCED & CORRECTED -->
        <div class="tab-pane fade" id="predictions">
            <h4 class="mb-3">Multi-Timeframe Predictions & Technical Analysis</h4>
            
            <!-- Symbol and Controls -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <label class="form-label fw-bold">Prediction Symbol</label>
                    <input id="predictionSymbol" class="form-control" value="BTC/USDT" placeholder="e.g. ETH/USDT">
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Primary Timeframe</label>
                    <select id="primaryTimeframe" class="form-select">
                        <option value="1h">1 Hour</option>
                        <option value="4h" selected>4 Hours</option>
                        <option value="1d">1 Day</option>
                        <option value="1w">1 Week</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Analysis Depth</label>
                    <select id="analysisDepth" class="form-select">
                        <option value="50">50 Candles</option>
                        <option value="100" selected>100 Candles</option>
                        <option value="200">200 Candles</option>
                        <option value="500">500 Candles</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-primary w-100" onclick="runMultiTimeframeAnalysis()">Analyze All</button>
                </div>
            </div>
            
            <!-- Main Prediction Card -->
            <div class="card mb-4 border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Overall Market Prediction & Signals</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div id="mainPredictionSignal" class="text-center p-3 rounded mb-3">
                                <h3 class="mb-2">LOADING...</h3>
                                <p class="mb-1">Overall Trend: <span id="overallTrend">-</span></p>
                                <p class="mb-1">Confidence: <span id="overallConfidence">-</span>%</p>
                                <p class="mb-0">Recommended Action: <span id="recommendedAction">-</span></p>
                            </div>
                            
                            <div class="row">
                                <div class="col-6">
                                    <div class="card h-100">
                                        <div class="card-header bg-light">Next 1H Prediction</div>
                                        <div class="card-body text-center">
                                            <h4 id="pred1hChange" class="mb-1">-</h4>
                                            <small id="pred1hSignal" class="text-muted">Signal: -</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="card h-100">
                                        <div class="card-header bg-light">Next 4H Prediction</div>
                                        <div class="card-body text-center">
                                            <h4 id="pred4hChange" class="mb-1">-</h4>
                                            <small id="pred4hSignal" class="text-muted">Signal: -</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-light">Technical Summary</div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-6">
                                            <p class="mb-1"><strong>RSI Status:</strong> <span id="rsiStatus">-</span></p>
                                            <p class="mb-1"><strong>MACD:</strong> <span id="macdStatus">-</span></p>
                                            <p class="mb-1"><strong>Trend:</strong> <span id="trendStatus">-</span></p>
                                        </div>
                                        <div class="col-6">
                                            <p class="mb-1"><strong>Support:</strong> <span id="supportLevel">-</span></p>
                                            <p class="mb-1"><strong>Resistance:</strong> <span id="resistanceLevel">-</span></p>
                                            <p class="mb-1"><strong>Volatility:</strong> <span id="volatilityStatus">-</span></p>
                                        </div>
                                    </div>
                                    <hr>
                                    <p class="mb-1"><strong>Key Levels:</strong></p>
                                    <div class="small">
                                        <p class="mb-1">Immediate Support: <span id="immediateSupport">-</span></p>
                                        <p class="mb-1">Immediate Resistance: <span id="immediateResistance">-</span></p>
                                        <p class="mb-0">Stop Loss Zone: <span id="stopLossZone">-</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chart Visualization -->
            <div class="card mb-4">
                <div class="card-header">Live Chart Visualization</div>
                <div class="card-body p-0">
                    <!-- TradingView Widget -->
                    <div class="tradingview-widget-container" style="height: 400px;">
                        <div id="tradingview_chart" style="height: 100%; width: 100%;"></div>
                        <div class="tradingview-widget-copyright">
                            <a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank">
                                <span class="blue-text">Track all markets on TradingView</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Multi-Timeframe Analysis Table -->
            <div class="card">
                <div class="card-header">Detailed Timeframe Analysis</div>
                <div class="card-body p-0">
                    <table class="table table-bordered table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Timeframe</th>
                                <th>Predicted %</th>
                                <th>Signal</th>
                                <th>Confidence</th>
                                <th>RSI</th>
                                <th>MACD</th>
                                <th>Support</th>
                                <th>Resistance</th>
                                <th>Recommendation</th>
                            </tr>
                        </thead>
                        <tbody id="timeframeAnalysisBody">
                            <tr><td colspan="9" class="text-center text-muted">Run analysis to see predictions</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Prediction History -->
            <div class="card mt-4">
                <div class="card-header">Recent Predictions Log</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Symbol</th>
                                    <th>Timeframe</th>
                                    <th>Prediction</th>
                                    <th>Actual</th>
                                    <th>Accuracy</th>
                                    <th>Signal</th>
                                </tr>
                            </thead>
                            <tbody id="predictionHistoryBody">
                                <tr><td colspan="7" class="text-center text-muted">No prediction history yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- SYSTEM -->
        <div class="tab-pane fade" id="system">
            <div class="text-center my-3">
                <h4>Binance Symbol Sync</h4>
                <p>Fetch all Binance spot symbols via ccxt and store only new ones in the database.</p>
                <button class="btn btn-secondary" onclick="syncBinanceSymbols()">Sync Binance Symbols</button>
                <div id="symbolSyncAlert" class="mt-3"></div>
            </div>
            <table class="table table-sm table-bordered w-50 mx-auto">
                <tbody>
                    <tr><th>Total markets</th><td id="syncTotal">-</td></tr>
                    <tr><th>Already in DB</th><td id="syncExisting">-</td></tr>
                    <tr><th>Newly added</th><td id="syncNew">-</td></tr>
                </tbody>
            </table>
        </div>

        <!-- SYMBOLS -->
        <div class="tab-pane fade" id="symbols">
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <input id="symbolSearch" class="form-control" placeholder="Search e.g. USDT, USDC, BTC, ETH, BTC/USDT">
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary w-100" onclick="searchSymbols()">Search</button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-success w-100" onclick="exportSymbolsExcel()">Export Excel</button>
                </div>
            </div>
            <div id="symbolsAlert"></div>
            <table class="table table-bordered table-sm">
                <thead class="table-dark">
                    <tr>
                        <th>#</th><th>Symbol</th><th>Base</th><th>Quote</th><th>Active</th><th>Added At</th>
                    </tr>
                </thead>
                <tbody id="symbolsBody"></tbody>
            </table>
        </div>

        <!-- TRAIN BOT -->
        <div class="tab-pane fade" id="trainBot">
            <h4 class="mb-3">Train Prediction Model</h4>
            <div class="row g-3 mb-3">
                <div class="col-md-4">
                    <label class="form-label">Symbol</label>
                    <input id="trainSymbol" class="form-control" value="BTC/USDT" placeholder="e.g. ETH/USDT">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Timeframes (multi-select)</label>
                    <select id="trainTimeframes" class="form-select" multiple>
                        <option value="1m">1m</option>
                        <option value="5m">5m</option>
                        <option value="15m">15m</option>
                        <option value="1h">1h</option>
                        <option value="4h" selected>4h</option>
                        <option value="1d">1d</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Look Back</label>
                    <input id="trainLookBack" type="number" class="form-control" value="50" min="10" max="200">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-primary w-100" onclick="trainBot()">Train Model</button>
                </div>
            </div>
            <div id="trainAlert"></div>
            <p class="text-muted">Trains patterns and weights from DB data. Run once per symbol/timeframe or after new data.</p>
        </div>

        <!-- PREDICT CANDLE -->
        <div class="tab-pane fade" id="predictCandle">
            <h4 class="mb-3">Predict Next Candle</h4>
            <div class="row g-3 mb-3">
                <div class="col-md-3">
                    <label class="form-label">Symbol</label>
                    <input id="predictSymbol" class="form-control" value="BTC/USDT" placeholder="e.g. ETH/USDT">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Timeframe</label>
                    <select id="predictTimeframe" class="form-select">
                        <option value="1m">1m</option>
                        <option value="5m">5m</option>
                        <option value="15m">15m</option>
                        <option value="1h">1h</option>
                        <option value="4h" selected>4h</option>
                        <option value="1d">1d</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Look Back</label>
                    <input id="predictLookBack" type="number" class="form-control" value="50" min="10" max="200">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Expander</label>
                    <input id="predictExpander" type="number" class="form-control" value="1.33" min="1.0" max="2.0" step="0.01">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-success w-100" onclick="predictCandle()">Predict</button>
                </div>
            </div>
            <div id="predictAlert"></div>
            <div id="predictResults" class="border p-3 bg-light rounded mt-3">
                <p class="text-muted">Run prediction to see results here (predicted % change, high/low bounds, confidence).</p>
            </div>
        </div>
    </div>
</div>

<script>
// Change this if your Flask runs on different port/host
const API = "http://127.0.0.1:8000";

function showAlert(id, msg, type = "danger") {
    const alertDiv = document.getElementById(id);
    if (alertDiv) {
        alertDiv.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show">
                ${msg}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
    }
}

// === EXCHANGE CHECKBOX FUNCTIONS ===
function toggleAllExchanges() {
    const allCheckbox = document.getElementById("exchangeAll");
    const exchangeCheckboxes = document.querySelectorAll(".exchange-checkbox");
    
    exchangeCheckboxes.forEach(checkbox => {
        checkbox.checked = allCheckbox.checked;
    });
    
    updateExchangeStatus();
    updateRealTime();
}

function updateExchangeSelection() {
    const exchangeCheckboxes = document.querySelectorAll(".exchange-checkbox");
    const allCheckbox = document.getElementById("exchangeAll");
    
    // Check if all exchange checkboxes are checked
    let allChecked = true;
    exchangeCheckboxes.forEach(checkbox => {
        if (!checkbox.checked) allChecked = false;
    });
    
    allCheckbox.checked = allChecked;
    updateExchangeStatus();
    updateRealTime();
}

function updateExchangeStatus() {
    const exchangeCheckboxes = document.querySelectorAll(".exchange-checkbox:checked");
    const exchangeNames = Array.from(exchangeCheckboxes).map(cb => {
        const value = cb.value;
        return value.charAt(0).toUpperCase() + value.slice(1);
    });
    
    const statusElement = document.getElementById("exchangeStatus");
    if (exchangeNames.length === 0) {
        statusElement.innerHTML = '<small class="text-danger">No exchanges selected. Please select at least one exchange.</small>';
    } else {
        statusElement.innerHTML = `<small>Selected: ${exchangeNames.join(', ')}</small>`;
    }
}

function getSelectedExchanges() {
    const exchangeCheckboxes = document.querySelectorAll(".exchange-checkbox:checked");
    return Array.from(exchangeCheckboxes).map(cb => cb.value);
}

// === ENHANCED PREDICTION FUNCTIONS ===
async function runMultiTimeframeAnalysis() {
    const symbol = document.getElementById("predictionSymbol").value.trim().toUpperCase().replace(/[-_]/g, '/');
    const primaryTimeframe = document.getElementById("primaryTimeframe").value;
    const depth = parseInt(document.getElementById("analysisDepth").value);
    
    if (!symbol) {
        alert("Please enter a symbol");
        return;
    }
    
    // Update chart
    updateTradingViewChart(symbol);
    
    // Show loading state
    const mainSignal = document.getElementById("mainPredictionSignal");
    if (mainSignal) {
        mainSignal.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 mb-0">Analyzing ${symbol}...</p>
            </div>
        `;
    }
    
    try {
        // Fetch multi-timeframe analysis
        const res = await fetch(API + "/multi_timeframe_analysis", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                symbol: symbol,
                timeframes: ["1h", "4h", "1d", "1w"],
                look_back: depth
            })
        });
        
        const data = await res.json();
        
        if (!data.success) {
            throw new Error(data.error || "Analysis failed");
        }
        
        // Update UI with predictions
        updatePredictionUI(data);
        
        // Store in history
        addToPredictionHistory(symbol, data);
        
    } catch (error) {
        console.error("Analysis error:", error);
        const mainSignal = document.getElementById("mainPredictionSignal");
        if (mainSignal) {
            mainSignal.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error:</strong> ${error.message}
                </div>
            `;
        }
    }
}

function updatePredictionUI(data) {
    const predictions = data.predictions;
    const summary = data.summary;
    
    // Update main prediction signal
    const mainSignal = document.getElementById("mainPredictionSignal");
    if (mainSignal) {
        const signalClass = summary.overall_signal.toLowerCase().includes('bull') ? 'signal-strong-bullish' : 
                           summary.overall_signal.toLowerCase().includes('bear') ? 'signal-bearish' : 'signal-neutral';
        
        mainSignal.innerHTML = `
            <h3 class="mb-2 ${signalClass}">${summary.overall_signal}</h3>
            <p class="mb-1">Overall Trend: <span id="overallTrend">${summary.trend_direction}</span></p>
            <p class="mb-1">Confidence: <span id="overallConfidence" class="${getConfidenceClass(summary.confidence)}">${summary.confidence}%</span></p>
            <p class="mb-0">Recommended Action: <span id="recommendedAction">${summary.recommended_action}</span></p>
        `;
    }
    
    // Update timeframe predictions
    const timeframeMap = {
        '1h': { change: 'pred1hChange', signal: 'pred1hSignal' },
        '4h': { change: 'pred4hChange', signal: 'pred4hSignal' }
    };
    
    predictions.forEach(pred => {
        const elements = timeframeMap[pred.timeframe];
        if (elements && elements.change) {
            const changeElement = document.getElementById(elements.change);
            const signalElement = document.getElementById(elements.signal);
            
            if (changeElement) {
                const changeValue = parseFloat(pred.predicted_change);
                const changeClass = changeValue >= 0 ? 'text-success' : 'text-danger';
                changeElement.innerHTML = `<span class="${changeClass}">${changeValue >= 0 ? '+' : ''}${changeValue.toFixed(2)}%</span>`;
            }
            
            if (signalElement) {
                signalElement.textContent = `Signal: ${pred.signal}`;
            }
        }
    });
    
    // Update technical summary - SAFE CHECK
    const rsiStatusElem = document.getElementById("rsiStatus");
    const macdStatusElem = document.getElementById("macdStatus");
    const trendStatusElem = document.getElementById("trendStatus");
    const supportLevelElem = document.getElementById("supportLevel");
    const resistanceLevelElem = document.getElementById("resistanceLevel");
    const volatilityStatusElem = document.getElementById("volatilityStatus");
    
    if (rsiStatusElem) rsiStatusElem.innerHTML = getRSIStatus(summary.rsi);
    if (macdStatusElem) macdStatusElem.innerHTML = getMACDStatus(summary.macd);
    if (trendStatusElem) trendStatusElem.textContent = summary.trend_direction;
    if (supportLevelElem) supportLevelElem.textContent = formatPrice(summary.support_levels && summary.support_levels[0]);
    if (resistanceLevelElem) resistanceLevelElem.textContent = formatPrice(summary.resistance_levels && summary.resistance_levels[0]);
    if (volatilityStatusElem) volatilityStatusElem.textContent = summary.volatility || 'Low';
    
    // Update key levels - SAFE CHECK
    const immediateSupportElem = document.getElementById("immediateSupport");
    const immediateResistanceElem = document.getElementById("immediateResistance");
    const stopLossZoneElem = document.getElementById("stopLossZone");
    
    if (immediateSupportElem) immediateSupportElem.textContent = formatPrice(summary.support_levels && summary.support_levels[0]);
    if (immediateResistanceElem) immediateResistanceElem.textContent = formatPrice(summary.resistance_levels && summary.resistance_levels[0]);
    if (stopLossZoneElem) stopLossZoneElem.textContent = formatPrice(summary.stop_loss_level);
    
    // Update detailed timeframe analysis table
    updateTimeframeAnalysisTable(predictions);
}

function getConfidenceClass(confidence) {
    if (confidence >= 80) return 'prediction-high';
    if (confidence >= 60) return 'prediction-medium';
    return 'prediction-low';
}

function getRSIStatus(rsi) {
    if (!rsi) return '<span class="text-muted">N/A</span>';
    if (rsi < 30) return `<span class="text-success">${rsi.toFixed(1)} (Oversold)</span>`;
    if (rsi > 70) return `<span class="text-danger">${rsi.toFixed(1)} (Overbought)</span>`;
    if (rsi > 50) return `<span class="text-success">${rsi.toFixed(1)} (Bullish)</span>`;
    return `<span class="text-danger">${rsi.toFixed(1)} (Bearish)</span>`;
}

function getMACDStatus(macdData) {
    if (!macdData || !macdData.macd || !macdData.signal) return '<span class="text-muted">N/A</span>';
    
    const macd = parseFloat(macdData.macd);
    const signal = parseFloat(macdData.signal);
    
    if (macd > signal && macd > 0) return `<span class="text-success">Bullish</span>`;
    if (macd < signal && macd < 0) return `<span class="text-danger">Bearish</span>`;
    if (macd > signal) return `<span class="text-warning">Weak Bullish</span>`;
    return `<span class="text-warning">Weak Bearish</span>`;
}

function formatPrice(price) {
    if (!price) return 'N/A';
    const numPrice = parseFloat(price);
    if (numPrice < 1) {
        return numPrice.toFixed(6);
    } else if (numPrice < 1000) {
        return numPrice.toFixed(2);
    } else {
        return numPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }
}

function updateTimeframeAnalysisTable(predictions) {
    const tbody = document.getElementById("timeframeAnalysisBody");
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    predictions.forEach(pred => {
        const change = parseFloat(pred.predicted_change);
        const signalClass = pred.signal.toLowerCase().includes('bull') ? 'signal-bullish' : 
                          pred.signal.toLowerCase().includes('bear') ? 'signal-bearish' : 'signal-neutral';
        
        const row = document.createElement("tr");
        row.innerHTML = `
            <td><strong>${pred.timeframe}</strong></td>
            <td class="${change >= 0 ? 'text-success' : 'text-danger'} fw-bold">
                ${change >= 0 ? '+' : ''}${change.toFixed(2)}%
            </td>
            <td><span class="${signalClass}">${pred.signal}</span></td>
            <td>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar ${getConfidenceClass(pred.confidence).replace('prediction-', 'bg-')}" 
                         role="progressbar" 
                         style="width: ${pred.confidence}%"
                         aria-valuenow="${pred.confidence}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        ${pred.confidence}%
                    </div>
                </div>
            </td>
            <td>${pred.rsi ? pred.rsi.toFixed(1) : 'N/A'}</td>
            <td>${pred.macd_status || 'N/A'}</td>
            <td>${formatPrice(pred.support)}</td>
            <td>${formatPrice(pred.resistance)}</td>
            <td><strong>${pred.recommendation}</strong></td>
        `;
        tbody.appendChild(row);
    });
}

function addToPredictionHistory(symbol, data) {
    const tbody = document.getElementById("predictionHistoryBody");
    if (!tbody) return;
    
    const now = new Date();
    const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    // Create new row
    const row = document.createElement("tr");
    const mainPrediction = data.predictions[1] || data.predictions[0]; // Get 4h or first prediction
    
    row.innerHTML = `
        <td>${timeString}</td>
        <td>${symbol}</td>
        <td>${mainPrediction.timeframe}</td>
        <td class="${parseFloat(mainPrediction.predicted_change) >= 0 ? 'text-success' : 'text-danger'}">
            ${parseFloat(mainPrediction.predicted_change) >= 0 ? '+' : ''}${parseFloat(mainPrediction.predicted_change).toFixed(2)}%
        </td>
        <td>-</td>
        <td>-</td>
        <td><span class="${mainPrediction.signal.toLowerCase().includes('bull') ? 'signal-bullish' : 'signal-bearish'}">
            ${mainPrediction.signal}
        </span></td>
    `;
    
    // Insert at top
    if (tbody.firstChild && tbody.firstChild.textContent.includes('No prediction history')) {
        tbody.innerHTML = '';
    }
    tbody.insertBefore(row, tbody.firstChild);
    
    // Keep only last 10 entries
    const rows = tbody.getElementsByTagName('tr');
    if (rows.length > 10) {
        tbody.removeChild(rows[rows.length - 1]);
    }
}

// TradingView Chart
function updateTradingViewChart(symbol) {
    if (typeof TradingView === 'undefined') {
        console.error("TradingView library not loaded");
        return;
    }
    
    // Clean symbol for TradingView
    const cleanSymbol = symbol.replace('/', '').replace('USDT', 'USD');
    
    // Clear existing chart
    const chartContainer = document.getElementById("tradingview_chart");
    if (chartContainer) {
        chartContainer.innerHTML = '';
    }
    
    try {
        new TradingView.widget({
            "container_id": "tradingview_chart",
            "width": "100%",
            "height": "400",
            "symbol": `BINANCE:${cleanSymbol}`,
            "interval": "60",
            "timezone": "Etc/UTC",
            "theme": "dark",
            "style": "1",
            "locale": "en",
            "toolbar_bg": "#f1f3f6",
            "enable_publishing": false,
            "withdateranges": true,
            "hide_side_toolbar": false,
            "allow_symbol_change": true,
            "details": true,
            "studies": [
                "RSI@tv-basicstudies",
                "MACD@tv-basicstudies",
                "Volume@tv-basicstudies"
            ],
            "show_popup_button": true,
            "popup_width": "1000",
            "popup_height": "650"
        });
    } catch (error) {
        console.error("TradingView chart error:", error);
    }
}

// Auto-update predictions when tab is active
let predictionInterval = null;

document.querySelector('#mainTabs a[href="#predictions"]').addEventListener('shown.bs.tab', function() {
    // Run initial analysis
    setTimeout(runMultiTimeframeAnalysis, 500);
    
    // Set up auto-refresh every 30 seconds
    if (predictionInterval) clearInterval(predictionInterval);
    predictionInterval = setInterval(runMultiTimeframeAnalysis, 30000);
});

document.querySelector('#mainTabs a[href="#predictions"]').addEventListener('hide.bs.tab', function() {
    // Clear interval when leaving tab
    if (predictionInterval) {
        clearInterval(predictionInterval);
        predictionInterval = null;
    }
});

// Initialize TradingView on page load
document.addEventListener("DOMContentLoaded", function() {
    // Load TradingView chart after a delay
    setTimeout(() => {
        updateTradingViewChart("BTC/USDT");
    }, 2000);
});

// Auto-refresh predictions when symbol changes
document.getElementById("predictionSymbol").addEventListener("change", function() {
    if (document.querySelector('#predictions').classList.contains('active')) {
        runMultiTimeframeAnalysis();
    }
});

// Auto-refresh when primary timeframe changes
document.getElementById("primaryTimeframe").addEventListener("change", function() {
    if (document.querySelector('#predictions').classList.contains('active')) {
        runMultiTimeframeAnalysis();
    }
});

// Load prediction history on tab open
document.querySelector('#mainTabs a[href="#predictions"]').addEventListener('shown.bs.tab', async function() {
    // Load prediction history
    try {
        const symbol = document.getElementById("predictionSymbol").value.trim();
        const res = await fetch(`${API}/get_prediction_history?symbol=${encodeURIComponent(symbol)}&limit=10`);
        const data = await res.json();
        
        if (data.success && data.predictions.length > 0) {
            const tbody = document.getElementById("predictionHistoryBody");
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            data.predictions.forEach(pred => {
                const date = new Date(pred.created_at);
                const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${timeString}</td>
                    <td>${pred.symbol}</td>
                    <td>${pred.timeframe}</td>
                    <td class="${parseFloat(pred.predicted_change) >= 0 ? 'text-success' : 'text-danger'}">
                        ${parseFloat(pred.predicted_change) >= 0 ? '+' : ''}${parseFloat(pred.predicted_change).toFixed(2)}%
                    </td>
                    <td>${pred.actual_change !== null ? (parseFloat(pred.actual_change) >= 0 ? '+' : '') + parseFloat(pred.actual_change).toFixed(2) + '%' : '-'}</td>
                    <td>${pred.accuracy !== null ? pred.accuracy.toFixed(1) + '%' : '-'}</td>
                    <td><span class="${pred.signal.toLowerCase().includes('bull') ? 'signal-bullish' : pred.signal.toLowerCase().includes('bear') ? 'signal-bearish' : 'signal-neutral'}">
                        ${pred.signal}
                    </span></td>
                `;
                tbody.appendChild(row);
            });
        }
    } catch (error) {
        console.log("Could not load prediction history:", error);
    }
});

// === REAL-TIME FEATURES ===
async function setLiveSymbol() {
    const symbolInput = document.getElementById("liveSymbol").value.trim().toUpperCase();
    if (!symbolInput) {
        document.getElementById("liveSymbolStatus").innerHTML = '<span class="text-danger">Enter a symbol!</span>';
        return;
    }
    try {
        const res = await fetch(API + "/set_symbol", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ symbol: symbolInput })
        });
        const json = await res.json();
        if (json.success) {
            document.getElementById("liveSymbolStatus").innerHTML = `<span class="text-success">✓ Now tracking: ${symbolInput}</span>`;
        } else {
            document.getElementById("liveSymbolStatus").innerHTML = '<span class="text-danger">Failed to set symbol</span>';
        }
    } catch (e) {
        document.getElementById("liveSymbolStatus").innerHTML = '<span class="text-danger">Connection error</span>';
    }
}

async function updateRealTime() {
    try {
        const res = await fetch(API + "/realtime_data");
        const data = await res.json();

        const activeTab = document.querySelector('.tab-pane.active').id;

        // Order Book Tab
        if (activeTab === "orderbook") {
            const selectedExchanges = getSelectedExchanges();
            const depthLevels = parseInt(document.getElementById("depthLevels").value);
            
            if (selectedExchanges.length === 0) {
                document.getElementById("orderBookContent").innerHTML = `
                    <div class="alert alert-warning">
                        <strong>No exchanges selected!</strong> Please select at least one exchange to view the order book.
                    </div>`;
                return;
            }

            let bids_list, asks_list, total_buy, total_sell, imbalance, current_price, vwap, predicted;
            let last_update = data.last_update;
            let now = Date.now() / 1000;

            // Combine order books from selected exchanges
            let combined_bids = {};
            let combined_asks = {};
            let exchange_count = 0;
            
            for (let ex of selectedExchanges) {
                if (data.order_book && data.order_book[ex]) {
                    exchange_count++;
                    data.order_book[ex].bids.forEach(([p, q]) => {
                        combined_bids[p] = (combined_bids[p] || 0) + q;
                    });
                    data.order_book[ex].asks.forEach(([p, q]) => {
                        combined_asks[p] = (combined_asks[p] || 0) + q;
                    });
                }
            }
            
            if (exchange_count === 0) {
                document.getElementById("orderBookContent").innerHTML = `
                    <div class="alert alert-info">
                        <strong>No order book data available</strong> for selected exchanges. Please try again in a few seconds.
                    </div>`;
                return;
            }

            bids_list = Object.entries(combined_bids)
                .sort((a, b) => b[0] - a[0])
                .slice(0, depthLevels);
            asks_list = Object.entries(combined_asks)
                .sort((a, b) => a[0] - b[0])
                .slice(0, depthLevels);

            total_buy = bids_list.reduce((sum, [p, q]) => sum + q, 0);
            total_sell = asks_list.reduce((sum, [p, q]) => sum + q, 0);
            let total = total_buy + total_sell + 1e-8;
            imbalance = (total_buy - total_sell) / total;
            
            // Filter trades by selected exchanges
            let recent_trades = data.trades.filter(t => {
                return now - t[2] < 300 && selectedExchanges.includes(t[4]);
            });
            
            if (recent_trades.length > 0) {
                let vwap_sum = recent_trades.reduce((sum, t) => sum + t[0] * t[1], 0);
                let vol_sum = recent_trades.reduce((sum, t) => sum + t[1], 0);
                vwap = vol_sum > 0 ? vwap_sum / vol_sum : null;
                current_price = recent_trades[recent_trades.length - 1][0];
            } else {
                vwap = null;
                current_price = 0;
            }
            
            predicted = current_price * (1 + 0.005 * imbalance);

            let imbalancePct = (imbalance * 100).toFixed(2);
            let imbalanceClass = imbalance > 0 ? "imbalance-pos" : "imbalance-neg";
            let lastUpdate = new Date(last_update * 1000).toLocaleTimeString();

            let summaryHtml = `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Symbol:</strong> ${data.current_symbol}<br>
                        <strong>Last Update:</strong> ${lastUpdate}<br>
                        <strong>Current Price:</strong> ${current_price ? current_price.toFixed(6) : 'N/A'} USDT<br>
                        <strong>Exchanges:</strong> ${selectedExchanges.map(e => e.charAt(0).toUpperCase() + e.slice(1)).join(', ')}
                    </div>
                    <div class="col-md-6 text-end">
                        <strong>Buy Volume:</strong> ${total_buy.toFixed(2)}<br>
                        <strong>Sell Volume:</strong> ${total_sell.toFixed(2)}<br>
                        <strong>Depth Levels:</strong> ${depthLevels}<br>
                        <strong class="${imbalanceClass}">Imbalance: ${imbalancePct}%</strong>
                    </div>
                </div>
                <hr>
                <div class="row mb-3">
                    <div class="col"><strong>VWAP:</strong> ${vwap ? vwap.toFixed(6) : 'Calculating...'} USDT</div>
                    <div class="col text-end"><strong>Predicted Price:</strong> <span class="fs-5 fw-bold">${predicted.toFixed(6)}</span> USDT</div>
                </div>
            `;

            let bookHtml = `
                <div class="row">
                    <div class="col-md-6">
                        <h5>Asks (Sells) <span class="badge bg-danger">${asks_list.length} levels</span></h5>
                        <table class="table table-sm table-hover">
                            <thead class="table-danger"><tr><th>Price</th><th>Quantity</th><th>Total</th></tr></thead>
                            <tbody>
                                ${asks_list.map(([p, q], i) => {
                                    let cumulative = asks_list.slice(0, i + 1).reduce((sum, [_, qty]) => sum + qty, 0);
                                    return `<tr><td>${parseFloat(p).toFixed(6)}</td><td>${parseFloat(q).toFixed(2)}</td><td>${cumulative.toFixed(2)}</td></tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h5>Bids (Buys) <span class="badge bg-success">${bids_list.length} levels</span></h5>
                        <table class="table table-sm table-hover">
                            <thead class="table-success"><tr><th>Price</th><th>Quantity</th><th>Total</th></tr></thead>
                            <tbody>
                                ${bids_list.map(([p, q], i) => {
                                    let cumulative = bids_list.slice(0, i + 1).reduce((sum, [_, qty]) => sum + qty, 0);
                                    return `<tr><td>${parseFloat(p).toFixed(6)}</td><td>${parseFloat(q).toFixed(2)}</td><td>${cumulative.toFixed(2)}</td></tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            document.getElementById("orderBookContent").innerHTML = summaryHtml + bookHtml;
        }

        // Trades Tab - Show trades from selected exchanges
        if (activeTab === "trades") {
            const selectedExchanges = getSelectedExchanges();
            let tradesHtml = `
                <div class="mb-3">
                    <span class="badge bg-info">Filtering trades from: ${selectedExchanges.map(e => e.charAt(0).toUpperCase() + e.slice(1)).join(', ')}</span>
                </div>
                <table class="table table-sm table-hover">
                    <thead class="table-dark">
                        <tr><th>Time</th><th>Price</th><th>Volume</th><th>Side</th><th>Exchange</th></tr>
                    </thead>
                    <tbody>`;
            
            let filteredTrades = data.trades.filter(t => selectedExchanges.includes(t[4]));
            
            if (filteredTrades.length === 0) {
                tradesHtml += `<tr><td colspan="5" class="text-center text-muted">No trades from selected exchanges</td></tr>`;
            } else {
                filteredTrades.slice(-100).reverse().forEach(t => {
                    const side = t[3] === 'b' ? 'BUY' : 'SELL';
                    const color = t[3] === 'b' ? 'text-success' : 'text-danger';
                    const timeStr = new Date(t[2] * 1000).toLocaleTimeString();
                    tradesHtml += `<tr><td>${timeStr}</td><td>${t[0].toFixed(6)}</td><td>${t[1].toFixed(2)}</td><td class="${color}"><strong>${side}</strong></td><td>${t[4]}</td></tr>`;
                });
            }
            tradesHtml += `</tbody></table>`;
            document.getElementById("tradesContent").innerHTML = tradesHtml;
        }

    } catch (e) {
        console.error("Real-time update failed:", e);
        if (document.querySelector('.tab-pane.active').id === "orderbook") {
            document.getElementById("orderBookContent").innerHTML = `
                <div class="alert alert-danger">
                    <strong>Connection Error:</strong> Unable to fetch real-time data. Please check your connection.
                </div>`;
        }
    }
}

// Auto-refresh on live tabs
setInterval(() => {
    const active = document.querySelector('.tab-pane.active');
    if (active && ['orderbook', 'trades'].includes(active.id)) {
        updateRealTime();
    }
}, 2000);

// Trigger initial load when switching to live tabs
['orderbook', 'trades'].forEach(tabId => {
    document.querySelector(`#mainTabs a[href="#${tabId}"]`).addEventListener('shown.bs.tab', updateRealTime);
});

// Initialize exchange status on page load
document.addEventListener("DOMContentLoaded", function() {
    updateExchangeStatus();
    const currentYear = new Date().getFullYear();
    document.getElementById("fromYear").value = currentYear - 1;
    document.getElementById("toYear").value = currentYear;
});

// === ALL YOUR ORIGINAL FUNCTIONS (unchanged) ===
async function fetchOHLCV() {
    const symbol = document.getElementById("symbol").value.trim();
    const timeframe = document.getElementById("timeframe").value;
    const fromYear = document.getElementById("fromYear").value;
    const toYear = document.getElementById("toYear").value;
    showAlert("ohlcvAlert", "Fetching from Binance...", "info");
    try {
        const res = await fetch(API + "/fetch_data", {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({symbol, timeframe, from_year: fromYear, to_year: toYear})
        });
        const json = await res.json();
        if (json.success) {
            showAlert("ohlcvAlert", json.message, "success");
            displayOHLCV(json.data);
        } else {
            showAlert("ohlcvAlert", json.error || "Failed");
        }
    } catch(e) {
        showAlert("ohlcvAlert", "Error: "+e.message);
    }
}

async function loadFromDB() {
    const symbol = document.getElementById("symbol").value.trim().toUpperCase().replace(/[-_]/g, '/');
    const timeframe = document.getElementById("timeframe").value;
    const fromYear = document.getElementById("fromYear").value;
    const toYear = document.getElementById("toYear").value;

    let alertMsg = `Loading from DB: ${symbol} ${timeframe}`;
    if (fromYear) alertMsg += ` from ${fromYear}`;
    if (toYear) alertMsg += ` to ${toYear}`;
    showAlert("ohlcvAlert", alertMsg, "info");

    try {
        const payload = { symbol, timeframe };
        if (fromYear) payload.from_year = fromYear;
        if (toYear) payload.to_year = toYear;

        const res = await fetch(API + "/fetch_from_db", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const json = await res.json();
        if (json.success) {
            showAlert("ohlcvAlert", `Loaded ${json.data.length} rows from DB`, "success");
            displayOHLCV(json.data);
        } else {
            showAlert("ohlcvAlert", json.error || "No data in database for selected range", "warning");
        }
    } catch (e) {
        showAlert("ohlcvAlert", "Error: " + e.message, "danger");
    }
}

function displayOHLCV(rows) {
    const tbody = document.getElementById("ohlcvBody");
    tbody.innerHTML = "";
    // Sort rows descending by time (newest first)
    rows.sort((a, b) => new Date(b["Time (UTC)"] || b.time_utc) - new Date(a["Time (UTC)"] || a.time_utc));
    rows.forEach((r, i) => {
        const previousVol = (i < rows.length - 1) ? Number(rows[i + 1].volume || rows[i + 1].Volume) : null;
        const currentVol = Number(r.volume || r.Volume);
        const diff = previousVol !== null ? currentVol - previousVol : null;
        let volChangeHtml = 'N/A';
        if (diff !== null) {
            const className = diff > 0 ? 'positive' : 'negative';
            const sign = diff > 0 ? '+' : '';
            volChangeHtml = `<span class="${className}">${sign}${diff.toLocaleString(undefined, {maximumFractionDigits: 2})}</span>`;
        }
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${i+1}</td>
            <td>${r.time_utc || r["Time (UTC)"]}</td>
            <td>${Number(r.open || r.Open).toFixed(4)}</td>
            <td>${Number(r.high || r.High).toFixed(4)}</td>
            <td>${Number(r.low || r.Low).toFixed(4)}</td>
            <td>${Number(r.close || r.Close).toFixed(4)}</td>
            <td>${currentVol.toLocaleString()}</td>
            <td>${volChangeHtml}</td>
        `;
        tbody.appendChild(tr);
    });
}

async function analyzeSymbol() {
    const symbol = document.getElementById("signalSymbol").value.trim();
    const timeframe = document.getElementById("signalTimeframe").value;
    if (!symbol) {
        showAlert("signalAlert", "Please enter a symbol");
        return;
    }
    showAlert("signalAlert", `Analyzing ${symbol} ${timeframe}...`, "info");
    try {
        const res = await fetch(API + "/analyze_symbol", {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({symbol, timeframe})
        });
        const json = await res.json();
        if (!json.success) {
            showAlert("signalAlert", json.error || "Failed");
            return;
        }
        let cls = "signal-bullish";
        if (json.signal.startsWith("BEARISH")) cls = "signal-bearish";
        if (json.signal.startsWith("WATCH_")) cls = "signal-watch";
        const d = json;
        const ind = d.indicators;
        const c = d.last_candle;
        const html = `
            <p><strong>Symbol:</strong> ${d.symbol} &nbsp; <strong>Timeframe:</strong> ${d.timeframe}</p>
            <p><strong>Last Candle:</strong> ${c.time_utc} |
               O: ${c.open.toFixed(4)} H: ${c.high.toFixed(4)}
               L: ${c.low.toFixed(4)} C: ${c.close.toFixed(4)}
               Vol: ${c.volume.toLocaleString()}</p>
            <p><strong>RSI(14):</strong> ${ind.rsi ? ind.rsi.toFixed(2) : "n/a"} &nbsp;
               <strong>MACD:</strong> ${ind.macd ? ind.macd.toFixed(4) : "n/a"} &nbsp;
               <strong>Signal:</strong> ${ind.macd_signal ? ind.macd_signal.toFixed(4) : "n/a"}</p>
            <p><strong>EMA20:</strong> ${ind.ema20 ? ind.ema20.toFixed(4) : "n/a"} &nbsp;
               <strong>EMA50:</strong> ${ind.ema50 ? ind.ema50.toFixed(4) : "n/a"} &nbsp;
               <strong>EMA100:</strong> ${ind.ema100 ? ind.ema100.toFixed(4) : "n/a"} &nbsp;
               <strong>EMA200:</strong> ${ind.ema200 ? ind.ema200.toFixed(4) : "n/a"}</p>
            <p class="${cls}"><strong>Signal:</strong> ${d.signal} (score ${d.score})</p>
            <ul>${d.reasons.map(r => `<li>${r}</li>`).join("")}</ul>
        `;
        document.getElementById("signalDetails").innerHTML = html;
        showAlert("signalAlert", "Analysis completed", "success");
    } catch(e) {
        showAlert("signalAlert", "Error: "+e.message);
    }
}

async function refreshGainersLosers() {
    showAlert("gainersAlert", "Fetching from Binance...", "info");
    showAlert("losersAlert", "Fetching from Binance...", "info");
    try {
        const res = await fetch(API + "/fetch_gainers_losers");
        const json = await res.json();
        if (json.success) {
            showAlert("gainersAlert", json.message, "success");
            showAlert("losersAlert", json.message, "success");
            loadGainers();
            loadLosers();
        } else {
            showAlert("gainersAlert", json.error || "Failed");
            showAlert("losersAlert", json.error || "Failed");
        }
    } catch(e) {
        showAlert("gainersAlert", "Error: "+e.message);
        showAlert("losersAlert", "Error: "+e.message);
    }
}

async function loadGainers() {
    const res = await fetch(API + "/get_gainers");
    const json = await res.json();
    const tbody = document.getElementById("gainersBody");
    tbody.innerHTML = "";
    json.data.forEach((d, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${i+1}</td>
            <td><strong>${d.symbol}</strong></td>
            <td>$${Number(d.price).toFixed(6)}</td>
            <td class="positive">+${d.price_change_percent.toFixed(2)}%</td>
            <td>$${Number(d.volume_24h).toLocaleString()}</td>
        `;
        tbody.appendChild(tr);
    });
}

async function loadLosers() {
    const res = await fetch(API + "/get_losers");
    const json = await res.json();
    const tbody = document.getElementById("losersBody");
    tbody.innerHTML = "";
    json.data.forEach((d, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${i+1}</td>
            <td><strong>${d.symbol}</strong></td>
            <td>$${Number(d.price).toFixed(6)}</td>
            <td class="negative">${d.price_change_percent.toFixed(2)}%</td>
            <td>$${Number(d.volume_24h).toLocaleString()}</td>
        `;
        tbody.appendChild(tr);
    });
}

async function loadGainerSignals() {
    showAlert("gainerSignalsAlert", "Scanning gainers with full indicators...", "info");
    const tbody = document.getElementById("gainerSignalsBody");
    tbody.innerHTML = "";
    try {
        const res = await fetch(API + "/gainers_signals");
        const json = await res.json();
        if (!json.success) {
            showAlert("gainerSignalsAlert", json.error || "Failed");
            return;
        }
        json.data.forEach((d, i) => {
            let cls = "signal-bullish";
            if (d.signal.startsWith("STRONG_BEARISH") || d.signal.startsWith("BEARISH")) cls = "signal-bearish";
            if (d.signal.startsWith("WATCH_")) cls = "signal-watch";
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${i+1}</td>
                <td><strong>${d.symbol}</strong></td>
                <td class="${d.price_change_percent >= 0 ? "positive" : "negative"}">
                    ${d.price_change_percent.toFixed(2)}%
                </td>
                <td>$${Number(d.volume_24h).toLocaleString()}</td>
                <td>${d.close.toFixed(6)}</td>
                <td>${d.rsi ? d.rsi.toFixed(2) : "n/a"}</td>
                <td class="${cls}">${d.signal}</td>
                <td>${d.score}</td>
            `;
            tbody.appendChild(tr);
        });
        showAlert("gainerSignalsAlert", "Gainer signals ready", "success");
    } catch(e) {
        showAlert("gainerSignalsAlert", "Error: "+e.message);
    }
}

async function loadRotation() {
    showAlert("rotationAlert", "Scanning rotation opportunities...", "info");
    const container = document.getElementById("rotationResults");
    container.innerHTML = "";
    try {
        const res = await fetch(API + "/rotation_signals");
        const json = await res.json();
        if (!json.success) {
            showAlert("rotationAlert", json.error || "Failed");
            return;
        }
        const data = json.data;
        if (!data.length) {
            showAlert("rotationAlert", "No rotation candidates found.", "warning");
            return;
        }
        data.forEach((block, idx) => {
            const div = document.createElement("div");
            div.className = "card mb-3";
            let html = `
                <div class="card-header">
                    Pumped: <strong>${block.pumped_symbol}</strong>
                    (Cat: ${block.pumped_category}) – ${block.pumped_change_pct.toFixed(2)}%,
                    Vol: $${Number(block.pumped_volume).toLocaleString()}
                </div>
                <div class="card-body">
                    <table class="table table-sm table-bordered">
                        <thead class="table-info">
                            <tr>
                                <th>#</th><th>Symbol</th><th>Score</th><th>Label</th><th>RSI</th><th>24h %</th><th>Vol</th><th>Close</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            block.rotation_candidates.forEach((c, i) => {
                let cls = "signal-bullish";
                if (c.label.startsWith("STRONG_BEARISH") || c.label.startsWith("BEARISH")) cls = "signal-bearish";
                if (c.label.startsWith("WATCH_")) cls = "signal-watch";
                html += `
                    <tr>
                        <td>${i+1}</td>
                        <td><strong>${c.symbol}</strong></td>
                        <td>${c.score}</td>
                        <td class="${cls}">${c.label}</td>
                        <td>${c.rsi ? c.rsi.toFixed(2) : "n/a"}</td>
                        <td>${c.today_change_pct.toFixed(2)}%</td>
                        <td>$${Number(c.today_volume).toLocaleString()}</td>
                        <td>${c.close.toFixed(6)}</td>
                    </tr>
                `;
            });
            html += `</tbody></table></div>`;
            div.innerHTML = html;
            container.appendChild(div);
        });
        showAlert("rotationAlert", "Rotation candidates ready.", "success");
    } catch(e) {
        showAlert("rotationAlert", "Error: "+e.message);
    }
}

async function trainBot() {
    const symbol = document.getElementById("trainSymbol").value.trim().toUpperCase().replace(/[-_]/g, '/');
    const timeframes = Array.from(document.getElementById("trainTimeframes").selectedOptions).map(opt => opt.value);
    const lookBack = parseInt(document.getElementById("trainLookBack").value);
    
    if (!symbol || timeframes.length === 0) {
        showAlert("trainAlert", "Select symbol and at least one timeframe", "danger");
        return;
    }
    
    showAlert("trainAlert", "Training model...", "info");
    try {
        const res = await fetch(API + "/train_bot", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ symbol, timeframes, look_back: lookBack })
        });
        const json = await res.json();
        if (json.success) {
            showAlert("trainAlert", json.message, "success");
        } else {
            showAlert("trainAlert", json.error, "danger");
        }
    } catch (e) {
        showAlert("trainAlert", "Error: " + e.message, "danger");
    }
}

async function predictCandle() {
    const symbol = document.getElementById("predictSymbol").value.trim().toUpperCase().replace(/[-_]/g, '/');
    const timeframe = document.getElementById("predictTimeframe").value;
    const lookBack = parseInt(document.getElementById("predictLookBack").value);
    const expander = parseFloat(document.getElementById("predictExpander").value);
    
    if (!symbol) {
        showAlert("predictAlert", "Select symbol", "danger");
        return;
    }
    
    showAlert("predictAlert", "Predicting next candle...", "info");
    try {
        const res = await fetch(API + "/predict_candle", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ symbol, timeframe, look_back: lookBack, expander })
        });
        const json = await res.json();
        if (json.success) {
            showAlert("predictAlert", "Prediction ready", "success");
            displayPrediction(json.prediction);
        } else {
            showAlert("predictAlert", json.error, "danger");
        }
    } catch (e) {
        showAlert("predictAlert", "Error: " + e.message, "danger");
    }
}

function displayPrediction(pred) {
    const container = document.getElementById("predictResults");
    container.innerHTML = `
        <h5>Predicted Next Candle (Confidence: ${pred.confidence.toFixed(2)}%)</h5>
        <p><strong>% Close Change:</strong> ${pred.pct_close.toFixed(2)}% (Bounds: ${pred.close_low.toFixed(2)}% to ${pred.close_high.toFixed(2)}%)</p>
        <p><strong>% High Change:</strong> ${pred.pct_high.toFixed(2)}% (Bounds: ${pred.high_low.toFixed(2)}% to ${pred.high_high.toFixed(2)}%)</p>
        <p><strong>% Low Change:</strong> ${pred.pct_low.toFixed(2)}% (Bounds: ${pred.low_low.toFixed(2)}% to ${pred.low_high.toFixed(2)}%)</p>
        <small>Based on ${pred.matches} historical matches.</small>
    `;
}

async function syncBinanceSymbols() {
    showAlert("symbolSyncAlert", "Syncing Binance symbols...", "info");
    try {
        const res = await fetch(API + "/sync_binance_symbols", { method: "POST" });
        const json = await res.json();
        if (!json.success) {
            showAlert("symbolSyncAlert", json.error || "Sync failed");
            return;
        }
        document.getElementById("syncTotal").innerText = json.total_markets;
        document.getElementById("syncExisting").innerText = json.already_existing;
        document.getElementById("syncNew").innerText = json.newly_added;
        showAlert("symbolSyncAlert", `Sync complete. ${json.newly_added} new symbols added.`, "success");
    } catch (e) {
        showAlert("symbolSyncAlert", "Error: " + e.message);
    }
}

async function searchSymbols() {
    const q = document.getElementById("symbolSearch").value.trim();
    showAlert("symbolsAlert", "Searching symbols...", "info");
    try {
        const res = await fetch(`${API}/search_symbols?q=${encodeURIComponent(q)}`);
        const json = await res.json();
        if (!json.success) {
            showAlert("symbolsAlert", "Search failed");
            return;
        }
        const tbody = document.getElementById("symbolsBody");
        tbody.innerHTML = "";
        json.data.forEach((r, i) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${i + 1}</td>
                <td><strong>${r.symbol}</strong></td>
                <td>${r.base || ""}</td>
                <td>${r.quote || ""}</td>
                <td>${r.active ? "Yes" : "No"}</td>
                <td>${r.created_at || ""}</td>
            `;
            tbody.appendChild(tr);
        });
        showAlert("symbolsAlert", `Loaded ${json.data.length} symbols`, "success");
    } catch (e) {
        showAlert("symbolsAlert", "Error: " + e.message);
    }
}

function exportSymbolsExcel() {
    const q = document.getElementById("symbolSearch").value.trim();
    const url = `${API}/export_symbols_excel?q=${encodeURIComponent(q)}`;
    window.open(url, "_blank");
}

// Auto-load gainers/losers on tab open
document.querySelectorAll('#mainTabs a').forEach(tab => {
    tab.addEventListener('shown.bs.tab', e => {
        const href = e.target.getAttribute('href');
        if (href === '#gainers') loadGainers();
        if (href === '#losers') loadLosers();
        if (href === '#orderbook') updateExchangeStatus();
    });
});
</script>
</body>
</html>